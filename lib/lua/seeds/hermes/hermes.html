<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hermes</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg: #1a1a2e;
    --bg-item: #16213e;
    --bg-hover: #0f3460;
    --accent: #00d4ff;
    --text: #eee;
    --text-dim: #888;
    --text-submenu: #e8b84a;
}

body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    font-size: 14px;
    padding: 16px;
    border-radius: 12px;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.title {
    font-size: 20px;
    font-weight: 600;
    color: var(--accent);
}

.breadcrumb {
    font-size: 12px;
    color: var(--text-dim);
}

.menu {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    max-height: 400px;
    overflow-y: auto;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: var(--bg-item);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.1s;
}

.menu-item:hover, .menu-item.selected {
    background: var(--bg-hover);
}

.menu-item.submenu .label {
    color: var(--text-submenu);
}

.key {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 26px;
    height: 24px;
    padding: 0 6px;
    background: var(--accent);
    color: var(--bg);
    font-weight: 700;
    font-size: 13px;
    border-radius: 4px;
    margin-right: 12px;
    font-family: "SF Mono", Monaco, monospace;
}

.label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.arrow {
    color: var(--text-dim);
    font-size: 12px;
    margin-left: 8px;
}

.footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 11px;
    color: var(--text-dim);
    display: flex;
    gap: 16px;
}

.footer span {
    opacity: 0.7;
}

.search-container {
    margin-bottom: 12px;
    display: none;
}

.search-container.active {
    display: block;
}

.search-input {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-item);
    border: 2px solid var(--accent);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    outline: none;
}

.search-input::placeholder {
    color: var(--text-dim);
}

.search-path {
    font-size: 11px;
    color: var(--text-dim);
    margin-left: 8px;
    opacity: 0.7;
}

/* Scrollbar styling */
.menu::-webkit-scrollbar {
    width: 6px;
}
.menu::-webkit-scrollbar-track {
    background: transparent;
}
.menu::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
}

/* App Grid Styles */
.app-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    padding: 8px;
    max-height: 400px;
    overflow-y: auto;
}

.app-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.1s;
}

.app-item:hover, .app-item.selected {
    background: var(--bg-hover);
}

.app-icon {
    width: 48px;
    height: 48px;
    margin-bottom: 8px;
    border-radius: 10px;
    object-fit: contain;
    background: rgba(255,255,255,0.05);
}

.app-icon.missing {
    opacity: 0.3;
}

.app-name {
    font-size: 11px;
    text-align: center;
    color: var(--text);
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.app-search-container {
    margin-bottom: 12px;
}

.app-search-input {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-item);
    border: 2px solid var(--accent);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    outline: none;
}

.app-search-input::placeholder {
    color: var(--text-dim);
}

/* Window List Styles */
.window-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 400px;
    overflow-y: auto;
    padding: 4px 0;
}

.window-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: var(--bg-item);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.1s;
}

.window-item:hover, .window-item.selected {
    background: var(--bg-hover);
}

.window-space {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 22px;
    padding: 0 6px;
    background: var(--accent);
    color: var(--bg);
    font-weight: 600;
    font-size: 12px;
    border-radius: 4px;
    margin-right: 12px;
    font-family: "SF Mono", Monaco, monospace;
}

.window-title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 12px;
}

.window-app {
    color: var(--text-dim);
    font-size: 12px;
    white-space: nowrap;
}

.window-search-container {
    margin-bottom: 12px;
}

.window-search-input {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-item);
    border: 2px solid var(--accent);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    outline: none;
}

.window-search-input::placeholder {
    color: var(--text-dim);
}
</style>
</head>
<body>
<div class="header">
    <div class="title">Hermes</div>
    <div class="breadcrumb" id="breadcrumb"></div>
</div>
<div class="search-container" id="searchContainer">
    <input type="text" class="search-input" id="searchInput" placeholder="Search commands...">
</div>
<div class="menu" id="menu"></div>

<!-- App Mode -->
<div class="app-search-container" id="appSearchContainer" style="display: none;">
    <input type="text" class="app-search-input" id="appSearchInput" placeholder="Search apps..."
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
</div>
<div class="app-grid" id="appGrid" style="display: none;"></div>

<!-- Window Mode -->
<div class="window-search-container" id="windowSearchContainer" style="display: none;">
    <input type="text" class="window-search-input" id="windowSearchInput" placeholder="Search windows..."
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
</div>
<div class="window-list" id="windowList" style="display: none;"></div>

<div class="footer">
    <span>ESC close</span>
    <span>DEL back</span>
    <span>: search</span>
</div>

<script>
const HERMES = {
    commands: {},
    menuStack: [],
    currentMenu: null,
    selectedIndex: 0,
    searchMode: false,
    searchResults: [],
    flatCommands: [],

    // App mode state
    appMode: false,
    apps: [],
    filteredApps: [],
    appSearchQuery: '',
    appSelectedIndex: 0,

    // Window mode state
    windowMode: false,
    windows: [],
    filteredWindows: [],
    windowSearchQuery: '',
    windowSelectedIndex: 0,

    init() {
        document.addEventListener('keydown', (e) => this.handleKey(e));
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => this.onSearchInput(e.target.value));

        const appSearchInput = document.getElementById('appSearchInput');
        appSearchInput.addEventListener('input', (e) => this.onAppSearchInput(e.target.value));

        const windowSearchInput = document.getElementById('windowSearchInput');
        windowSearchInput.addEventListener('input', (e) => this.onWindowSearchInput(e.target.value));

        this.log('Hermes UI initialized');
    },

    log(msg) {
        window.webkit.messageHandlers.Hermes.postMessage({type: 'log', message: msg});
    },

    postMessage(msg) {
        window.webkit.messageHandlers.Hermes.postMessage(msg);
    },

    setCommands(cmds) {
        this.commands = cmds;
        this.currentMenu = cmds;
        this.menuStack = [];
        this.selectedIndex = 0;
        this.searchMode = false;
        this.flatCommands = this.flattenCommands(cmds, []);
        // Don't render if in app mode
        if (!this.appMode) {
            this.render();
        }
    },

    reset() {
        this.currentMenu = this.commands;
        this.menuStack = [];
        this.selectedIndex = 0;
        this.exitSearchMode();
        this.render();
    },

    flattenCommands(menu, path) {
        // Recursively flatten all commands for search
        const results = [];
        for (const [key, value] of Object.entries(menu)) {
            if (key === '_desc' || key.startsWith('_')) continue;

            if (Array.isArray(value)) {
                // Command entry
                results.push({
                    key,
                    label: value[0],
                    command: value[1],
                    path: [...path],
                    isSubmenu: false
                });
            } else if (typeof value === 'object' && value._desc) {
                // Submenu - recurse
                const subPath = [...path, value._desc];
                results.push(...this.flattenCommands(value, subPath));
            }
        }
        return results;
    },

    enterSearchMode() {
        this.searchMode = true;
        this.selectedIndex = 0;
        document.getElementById('searchContainer').classList.add('active');
        const searchInput = document.getElementById('searchInput');
        searchInput.value = '';
        searchInput.focus();
        this.searchResults = this.flatCommands;
        this.renderSearch();
    },

    exitSearchMode() {
        this.searchMode = false;
        this.selectedIndex = 0;
        const container = document.getElementById('searchContainer');
        const input = document.getElementById('searchInput');
        container.classList.remove('active');
        input.value = '';
        input.blur();
    },

    onSearchInput(query) {
        if (!this.searchMode) return;
        const q = query.toLowerCase();
        if (!q) {
            this.searchResults = this.flatCommands;
        } else {
            this.searchResults = this.flatCommands.filter(item =>
                item.label.toLowerCase().includes(q) ||
                item.path.some(p => p.toLowerCase().includes(q))
            );
        }
        this.selectedIndex = 0;
        this.renderSearch();
    },

    getMenuItems() {
        if (!this.currentMenu) return [];
        const items = [];
        for (const [key, value] of Object.entries(this.currentMenu)) {
            if (key === '_desc') continue;
            if (key.startsWith('_')) continue;

            let label, isSubmenu = false, command = null;

            if (Array.isArray(value)) {
                label = value[0];
                command = value[1];
            } else if (typeof value === 'object' && value._desc) {
                label = value._desc;
                isSubmenu = true;
            } else {
                continue;
            }

            items.push({key, label, isSubmenu, command, value});
        }
        items.sort((a, b) => a.key.localeCompare(b.key));
        return items;
    },

    render() {
        if (this.searchMode) {
            this.renderSearch();
            return;
        }

        const menuEl = document.getElementById('menu');
        const breadcrumbEl = document.getElementById('breadcrumb');

        const path = this.menuStack.map(m => m._desc || '').filter(Boolean);
        breadcrumbEl.textContent = path.join(' > ');

        const items = this.getMenuItems();
        menuEl.innerHTML = items.map((item, i) => `
            <div class="menu-item ${item.isSubmenu ? 'submenu' : ''} ${i === this.selectedIndex ? 'selected' : ''}"
                 data-key="${item.key}">
                <span class="key">${item.key}</span>
                <span class="label">${item.label}</span>
                ${item.isSubmenu ? '<span class="arrow">â–¸</span>' : ''}
            </div>
        `).join('');

        menuEl.querySelectorAll('.menu-item').forEach(el => {
            el.addEventListener('click', () => {
                const key = el.dataset.key;
                this.selectKey(key);
            });
        });
    },

    renderSearch() {
        const menuEl = document.getElementById('menu');
        const breadcrumbEl = document.getElementById('breadcrumb');
        breadcrumbEl.textContent = 'Search';

        menuEl.innerHTML = this.searchResults.slice(0, 30).map((item, i) => {
            const pathStr = item.path.length ? item.path.join(' > ') : '';
            return `
                <div class="menu-item ${i === this.selectedIndex ? 'selected' : ''}" data-index="${i}">
                    <span class="label">${item.label}${pathStr ? `<span class="search-path">${pathStr}</span>` : ''}</span>
                </div>
            `;
        }).join('');

        menuEl.querySelectorAll('.menu-item').forEach(el => {
            el.addEventListener('click', () => {
                const idx = parseInt(el.dataset.index);
                this.executeSearchResult(idx);
            });
        });
    },

    executeSearchResult(index) {
        const item = this.searchResults[index];
        if (item && item.command) {
            this.postMessage({type: 'execute', command: item.command});
        }
    },

    // ========================================================================
    // APP MODE FUNCTIONS
    // ========================================================================

    enterAppMode() {
        this.appMode = true;
        this.appSearchQuery = '';
        this.appSelectedIndex = 0;

        // Hide command mode elements
        document.getElementById('menu').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';

        // Show app mode elements
        document.getElementById('appSearchContainer').style.display = 'block';
        document.getElementById('appGrid').style.display = 'grid';

        // Update header
        document.getElementById('breadcrumb').textContent = 'Apps';
        document.querySelector('.title').textContent = 'App Launcher';

        // Focus search input
        const input = document.getElementById('appSearchInput');
        input.value = '';
        input.focus();

        // Request apps from Lua
        this.postMessage({type: 'get_apps'});
    },

    exitAppMode() {
        this.appMode = false;
        this.apps = [];
        this.filteredApps = [];
        this.appSearchQuery = '';
        this.appSelectedIndex = 0;

        // Hide app mode elements
        document.getElementById('appSearchContainer').style.display = 'none';
        document.getElementById('appGrid').style.display = 'none';

        // Show command mode elements
        document.getElementById('menu').style.display = 'grid';
        document.querySelector('.footer').style.display = 'flex';

        // Reset header
        document.querySelector('.title').textContent = 'Hermes';
        document.getElementById('breadcrumb').textContent = '';

        // Re-render command menu
        this.render();
    },

    setApps(apps) {
        this.apps = apps;
        this.filterApps();
        this.renderApps();

        // Request icon extraction for visible apps (first 18)
        this.filteredApps.slice(0, 18).forEach(app => {
            if (!this.iconExists(app.icon)) {
                this.postMessage({
                    type: 'extract_icon',
                    appPath: app.path,
                    appName: app.name
                });
            }
        });
    },

    iconExists(iconPath) {
        // Check if icon file exists by trying to load it
        // This is a heuristic - we'll just check if the path looks valid
        return iconPath && iconPath.length > 0;
    },

    updateAppIcon(appName, iconPath) {
        // Update icon for a specific app
        const img = document.querySelector(`.app-item[data-name="${CSS.escape(appName)}"] .app-icon`);
        if (img) {
            img.src = 'file://' + iconPath;
            img.classList.remove('missing');
        }
    },

    filterApps() {
        if (!this.appSearchQuery) {
            this.filteredApps = this.apps;
        } else {
            const q = this.appSearchQuery.toLowerCase();
            this.filteredApps = this.apps.filter(app =>
                app.name.toLowerCase().includes(q)
            );
        }
        this.appSelectedIndex = Math.min(this.appSelectedIndex, Math.max(0, this.filteredApps.length - 1));
    },

    onAppSearchInput(query) {
        this.appSearchQuery = query;
        this.appSelectedIndex = 0;
        this.filterApps();
        this.renderApps();
    },

    renderApps() {
        const grid = document.getElementById('appGrid');
        const maxApps = 18; // 6x3 grid
        const visible = this.filteredApps.slice(0, maxApps);

        grid.innerHTML = visible.map((app, i) => {
            const iconSrc = app.icon ? `file://${app.icon}` : '';
            const iconClass = iconSrc ? 'app-icon' : 'app-icon missing';
            return `
                <div class="app-item ${i === this.appSelectedIndex ? 'selected' : ''}"
                     data-index="${i}" data-name="${app.name}">
                    <img class="${iconClass}" src="${iconSrc}" onerror="this.classList.add('missing')">
                    <div class="app-name">${app.name}</div>
                </div>
            `;
        }).join('');

        // Add click handlers
        grid.querySelectorAll('.app-item').forEach(el => {
            el.addEventListener('click', () => {
                const idx = parseInt(el.dataset.index);
                this.launchApp(idx);
            });
        });
    },

    launchApp(index) {
        const app = this.filteredApps[index];
        if (app) {
            this.postMessage({type: 'launch_app', appName: app.name});
        }
    },

    // ========================================================================
    // WINDOW MODE FUNCTIONS
    // ========================================================================

    enterWindowMode() {
        this.windowMode = true;
        this.windowSearchQuery = '';
        this.windowSelectedIndex = 0;

        // Hide command mode elements
        document.getElementById('menu').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';

        // Show window mode elements
        document.getElementById('windowSearchContainer').style.display = 'block';
        document.getElementById('windowList').style.display = 'flex';

        // Update header
        document.getElementById('breadcrumb').textContent = 'Windows';
        document.querySelector('.title').textContent = 'Window Switcher';

        // Focus search input
        const input = document.getElementById('windowSearchInput');
        input.value = '';
        input.focus();

        // Request windows from Lua
        this.postMessage({type: 'get_windows'});
    },

    exitWindowMode() {
        this.windowMode = false;
        this.windows = [];
        this.filteredWindows = [];
        this.windowSearchQuery = '';
        this.windowSelectedIndex = 0;

        // Hide window mode elements
        document.getElementById('windowSearchContainer').style.display = 'none';
        document.getElementById('windowList').style.display = 'none';

        // Show command mode elements
        document.getElementById('menu').style.display = 'grid';
        document.querySelector('.footer').style.display = 'flex';

        // Reset header
        document.querySelector('.title').textContent = 'Hermes';
        document.getElementById('breadcrumb').textContent = '';

        // Re-render command menu
        this.render();
    },

    setWindows(windows) {
        this.windows = windows;
        this.filterWindows();
        this.renderWindows();
    },

    filterWindows() {
        if (!this.windowSearchQuery) {
            this.filteredWindows = this.windows;
        } else {
            const q = this.windowSearchQuery.toLowerCase();
            this.filteredWindows = this.windows.filter(win =>
                win.title.toLowerCase().includes(q) ||
                win.app.toLowerCase().includes(q)
            );
        }
        this.windowSelectedIndex = Math.min(this.windowSelectedIndex, Math.max(0, this.filteredWindows.length - 1));
    },

    onWindowSearchInput(query) {
        this.windowSearchQuery = query;
        this.windowSelectedIndex = 0;
        this.filterWindows();
        this.renderWindows();
    },

    renderWindows() {
        const list = document.getElementById('windowList');

        if (this.filteredWindows.length === 0) {
            list.innerHTML = '<div class="window-item"><span class="window-title">No windows found</span></div>';
            return;
        }

        list.innerHTML = this.filteredWindows.map((win, i) => `
            <div class="window-item ${i === this.windowSelectedIndex ? 'selected' : ''}"
                 data-index="${i}" data-id="${win.id}">
                <span class="window-space">${win.space}</span>
                <span class="window-title">${this.escapeHtml(win.title)}</span>
                <span class="window-app">${this.escapeHtml(win.app)}</span>
            </div>
        `).join('');

        // Add click handlers
        list.querySelectorAll('.window-item').forEach(el => {
            el.addEventListener('click', () => {
                const idx = parseInt(el.dataset.index);
                this.focusWindow(idx);
            });
        });

        // Scroll selected into view
        const selected = list.querySelector('.window-item.selected');
        if (selected) {
            selected.scrollIntoView({block: 'nearest'});
        }
    },

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    focusWindow(index) {
        const win = this.filteredWindows[index];
        if (win) {
            this.postMessage({type: 'focus_window', windowId: win.id});
        }
    },

    handleWindowKey(e) {
        const key = e.key;
        const visibleCount = this.filteredWindows.length;

        // Escape - exit window mode
        if (key === 'Escape') {
            e.preventDefault();
            this.exitWindowMode();
            return true;
        }

        // Enter - focus selected window
        if (key === 'Enter') {
            e.preventDefault();
            this.focusWindow(this.windowSelectedIndex);
            return true;
        }

        // Arrow navigation
        if (key === 'ArrowDown') {
            e.preventDefault();
            if (this.windowSelectedIndex < visibleCount - 1) {
                this.windowSelectedIndex++;
                this.renderWindows();
            }
            return true;
        }
        if (key === 'ArrowUp') {
            e.preventDefault();
            if (this.windowSelectedIndex > 0) {
                this.windowSelectedIndex--;
                this.renderWindows();
            }
            return true;
        }

        // Let other keys go to search input
        return false;
    },

    handleAppKey(e) {
        const key = e.key;
        const cols = 6;
        const maxApps = 18;
        const visibleCount = Math.min(this.filteredApps.length, maxApps);

        // Escape - exit app mode
        if (key === 'Escape') {
            e.preventDefault();
            this.exitAppMode();
            return true;
        }

        // Enter - launch selected app
        if (key === 'Enter') {
            e.preventDefault();
            this.launchApp(this.appSelectedIndex);
            return true;
        }

        // Arrow navigation
        if (key === 'ArrowDown') {
            e.preventDefault();
            if (this.appSelectedIndex + cols < visibleCount) {
                this.appSelectedIndex += cols;
                this.renderApps();
            }
            return true;
        }
        if (key === 'ArrowUp') {
            e.preventDefault();
            if (this.appSelectedIndex >= cols) {
                this.appSelectedIndex -= cols;
                this.renderApps();
            }
            return true;
        }
        if (key === 'ArrowRight') {
            e.preventDefault();
            if (this.appSelectedIndex < visibleCount - 1) {
                this.appSelectedIndex++;
                this.renderApps();
            }
            return true;
        }
        if (key === 'ArrowLeft') {
            e.preventDefault();
            if (this.appSelectedIndex > 0) {
                this.appSelectedIndex--;
                this.renderApps();
            }
            return true;
        }

        // Let other keys go to search input
        return false;
    },

    selectKey(key) {
        const item = this.currentMenu[key];
        if (!item) return;

        if (Array.isArray(item)) {
            const command = item[1];
            this.postMessage({type: 'execute', command});
        } else if (typeof item === 'object' && item._desc) {
            this.menuStack.push(this.currentMenu);
            this.currentMenu = item;
            this.selectedIndex = 0;
            this.render();
        }
    },

    goBack() {
        if (this.menuStack.length > 0) {
            this.currentMenu = this.menuStack.pop();
            this.selectedIndex = 0;
            this.render();
        }
    },

    handleKey(e) {
        const key = e.key;

        // Window mode gets priority
        if (this.windowMode) {
            if (this.handleWindowKey(e)) {
                return;
            }
            // Let other keys go to search input
            return;
        }

        // App mode gets priority
        if (this.appMode) {
            if (this.handleAppKey(e)) {
                return;
            }
            // Let other keys go to search input
            return;
        }

        // Global: = to edit config
        if (key === '=' && !this.searchMode) {
            e.preventDefault();
            this.postMessage({type: 'execute', command: 'nvim ~/dotfiles/lib/lua/seeds/hermes/commands.lua'});
            return;
        }

        // Escape - close (or exit search mode first)
        if (key === 'Escape') {
            e.preventDefault();
            if (this.searchMode) {
                this.exitSearchMode();
                this.render();
            } else {
                this.postMessage({type: 'close'});
            }
            return;
        }

        // Search mode handling
        if (this.searchMode) {
            if (key === 'ArrowDown') {
                e.preventDefault();
                this.selectedIndex = Math.min(this.selectedIndex + 1, this.searchResults.length - 1);
                this.renderSearch();
                return;
            }
            if (key === 'ArrowUp') {
                e.preventDefault();
                this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
                this.renderSearch();
                return;
            }
            if (key === 'Enter') {
                e.preventDefault();
                this.executeSearchResult(this.selectedIndex);
                return;
            }
            // Let other keys go to input
            return;
        }

        // Enter search mode with :
        if (key === ':') {
            e.preventDefault();
            this.enterSearchMode();
            return;
        }

        // Backspace/Delete - go back
        if (key === 'Backspace' || key === 'Delete') {
            e.preventDefault();
            if (this.menuStack.length > 0) {
                this.goBack();
            } else {
                this.postMessage({type: 'close'});
            }
            return;
        }

        // Arrow keys for selection
        const items = this.getMenuItems();
        if (key === 'ArrowDown') {
            e.preventDefault();
            this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
            this.render();
            return;
        }
        if (key === 'ArrowUp') {
            e.preventDefault();
            this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
            this.render();
            return;
        }

        // Enter - select current
        if (key === 'Enter') {
            e.preventDefault();
            if (items[this.selectedIndex]) {
                this.selectKey(items[this.selectedIndex].key);
            }
            return;
        }

        // 'a' at root level enters app mode
        if (key === 'a' && this.menuStack.length === 0 && !this.searchMode) {
            e.preventDefault();
            this.enterAppMode();
            return;
        }

        // 'w' at root level enters window mode
        if (key === 'w' && this.menuStack.length === 0 && !this.searchMode) {
            e.preventDefault();
            this.enterWindowMode();
            return;
        }

        // Single character - direct selection
        if (key.length === 1) {
            e.preventDefault();
            const lowerKey = key.toLowerCase();
            if (this.currentMenu[lowerKey]) {
                this.selectKey(lowerKey);
            } else if (this.currentMenu[key]) {
                this.selectKey(key);
            }
        }
    }
};

document.addEventListener('DOMContentLoaded', () => HERMES.init());
</script>
</body>
</html>
