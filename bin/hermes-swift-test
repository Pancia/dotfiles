#!/usr/bin/swift

import AppKit
import Foundation

// Record start time immediately
let startTime = CFAbsoluteTimeGetCurrent()

class HermesWindow: NSWindow {
    override var canBecomeKey: Bool { true }
    override var canBecomeMain: Bool { true }
}

class HermesDelegate: NSObject, NSApplicationDelegate {
    var window: NSWindow!
    let createTime: CFAbsoluteTime

    override init() {
        self.createTime = CFAbsoluteTimeGetCurrent()
        super.init()
    }

    func applicationDidFinishLaunching(_ notification: Notification) {
        let launchTime = CFAbsoluteTimeGetCurrent()

        // Create floating panel-style window
        let screenFrame = NSScreen.main?.frame ?? NSRect(x: 0, y: 0, width: 1920, height: 1080)
        let windowWidth: CGFloat = 500
        let windowHeight: CGFloat = 400
        let windowX = (screenFrame.width - windowWidth) / 2
        let windowY = (screenFrame.height - windowHeight) / 2

        window = HermesWindow(
            contentRect: NSRect(x: windowX, y: windowY, width: windowWidth, height: windowHeight),
            styleMask: [.borderless],
            backing: .buffered,
            defer: false
        )

        window.isOpaque = false
        window.backgroundColor = NSColor(red: 0.1, green: 0.1, blue: 0.18, alpha: 0.98)
        window.level = .floating
        window.hasShadow = true

        // Create content view
        let contentView = NSView(frame: window.contentView!.bounds)
        contentView.wantsLayer = true
        contentView.layer?.cornerRadius = 12
        contentView.layer?.masksToBounds = true
        contentView.layer?.backgroundColor = NSColor(red: 0.1, green: 0.1, blue: 0.18, alpha: 1).cgColor

        // Title label
        let titleLabel = NSTextField(labelWithString: "Hermes")
        titleLabel.font = NSFont.systemFont(ofSize: 24, weight: .bold)
        titleLabel.textColor = NSColor(red: 0, green: 0.83, blue: 1, alpha: 1)
        titleLabel.frame = NSRect(x: 20, y: windowHeight - 50, width: 200, height: 30)
        contentView.addSubview(titleLabel)

        // Menu items
        let items = [
            ("a", "Applications", true),
            ("w", "Windows", false),
            ("s", "System", true),
            ("t", "Tools", true),
            ("c", "Claude", false),
            (":", "Search...", false)
        ]

        var yOffset = windowHeight - 90
        for (key, label, hasSubmenu) in items {
            let itemView = createMenuItem(key: key, label: label, hasSubmenu: hasSubmenu, y: yOffset, width: windowWidth - 40)
            contentView.addSubview(itemView)
            yOffset -= 44
        }

        window.contentView = contentView
        window.makeKeyAndOrderFront(nil)

        let showTime = CFAbsoluteTimeGetCurrent()

        // Calculate timings
        let initMs = (createTime - startTime) * 1000
        let launchMs = (launchTime - startTime) * 1000
        let showMs = (showTime - startTime) * 1000

        let results = """
        Swift Profile Results:
          Script start to init: \(String(format: "%.1f", initMs))ms
          Script start to launch: \(String(format: "%.1f", launchMs))ms
          Script start to show: \(String(format: "%.1f", showMs))ms
          TOTAL: \(String(format: "%.1f", showMs))ms
        """
        print(results)

        // Auto-close after 3 seconds
        DispatchQueue.main.asyncAfter(deadline: .now() + 3) {
            NSApplication.shared.terminate(nil)
        }
    }

    func createMenuItem(key: String, label: String, hasSubmenu: Bool, y: CGFloat, width: CGFloat) -> NSView {
        let itemView = NSView(frame: NSRect(x: 20, y: y, width: width, height: 40))
        itemView.wantsLayer = true
        itemView.layer?.backgroundColor = NSColor(red: 0.086, green: 0.13, blue: 0.24, alpha: 1).cgColor
        itemView.layer?.cornerRadius = 6

        // Key badge
        let keyLabel = NSTextField(labelWithString: key)
        keyLabel.font = NSFont.monospacedSystemFont(ofSize: 14, weight: .bold)
        keyLabel.textColor = NSColor(red: 0.1, green: 0.1, blue: 0.18, alpha: 1)
        keyLabel.backgroundColor = NSColor(red: 0, green: 0.83, blue: 1, alpha: 1)
        keyLabel.drawsBackground = true
        keyLabel.alignment = .center
        keyLabel.frame = NSRect(x: 10, y: 8, width: 28, height: 24)
        keyLabel.wantsLayer = true
        keyLabel.layer?.cornerRadius = 4
        keyLabel.layer?.masksToBounds = true
        itemView.addSubview(keyLabel)

        // Label
        let textLabel = NSTextField(labelWithString: label)
        textLabel.font = NSFont.systemFont(ofSize: 15)
        textLabel.textColor = .white
        textLabel.frame = NSRect(x: 50, y: 10, width: width - 100, height: 20)
        itemView.addSubview(textLabel)

        // Submenu indicator
        if hasSubmenu {
            let arrowLabel = NSTextField(labelWithString: ">")
            arrowLabel.font = NSFont.systemFont(ofSize: 14)
            arrowLabel.textColor = NSColor(white: 0.5, alpha: 1)
            arrowLabel.frame = NSRect(x: width - 30, y: 10, width: 20, height: 20)
            itemView.addSubview(arrowLabel)
        }

        return itemView
    }

    func applicationShouldTerminateAfterLastWindowClosed(_ sender: NSApplication) -> Bool {
        return true
    }
}

// Run the app
let app = NSApplication.shared
let delegate = HermesDelegate()
app.delegate = delegate
app.setActivationPolicy(.accessory)  // Don't show in dock
app.run()
