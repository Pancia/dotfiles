#!/usr/bin/env fish

# YouTube download utility
# Interactive downloads bypass .ytdl files and download directly

# ============================================================================
# CONFIGURATION
# ============================================================================

set -g YTDL_VALID_TYPES music audio video text notes
set -g YTDL_OUTPUT_DIR ~/Cloud/ytdl
set -g YTDL_AUDIO_CODE "bestaudio"
set -g YTDL_VIDEO_CODE "bestvideo[ext=mp4][height<=480][vcodec^=avc]+bestaudio"
set -g YTDL_PLAYLIST_FMT "%(playlist_title)s"

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

function _ytdl_select_type
    set -l selected (printf '%s\n' $YTDL_VALID_TYPES | fzf --prompt="ytdl type> " --height=10)
    if test -z "$selected"
        return 1
    end
    echo $selected
end

function _ytdl_validate_type
    contains -- $argv[1] $YTDL_VALID_TYPES
end

function _ytdl_extract_video_id
    set -l input $argv[1]
    if string match -qr '^(https|www|youtube)' -- $input
        echo $input | string replace -r '.*v=([^&]*).*' '$1'
    else
        echo $input
    end
end

function _ytdl_run
    set -l ytid $argv[1]
    set -l extra_args $argv[2..-1]

    echo "yt-dlp $extra_args -- \"$ytid\""
    set -l output (yt-dlp $extra_args -- $ytid 2>&1)
    set -l exit_code $status
    echo $output

    # Retry with cookies if age-restricted
    if test $exit_code -ne 0
        if string match -qri 'Sign in to confirm your age|age-restricted|login required' -- "$output"
            echo ""
            echo "[Age-restricted detected, retrying with cookies...]"
            set output (yt-dlp $extra_args --cookies-from-browser brave -- $ytid 2>&1)
            set exit_code $status
            echo $output
        end
    end

    return $exit_code
end

function _ytdl_convert_mp4_to_m4a
    set -l out_dir $argv[1]
    set -l ytid $argv[2]
    # Only convert mp4 files matching this video ID
    for mp4_file in $out_dir/*__#__$ytid.mp4
        if test -f "$mp4_file"
            set -l m4a_file (string replace -r '\.mp4$' '.m4a' -- $mp4_file)
            if not test -f "$m4a_file"
                echo "[Converting] $mp4_file -> $m4a_file"
                ffmpeg -i $mp4_file $m4a_file
                and trash $mp4_file
            end
        end
    end
end

# ============================================================================
# DOWNLOAD FUNCTIONS
# ============================================================================

function _ytdl_download_media
    set -l ytid $argv[1]
    set -l download_type $argv[2]
    set -l video_type $argv[3] # "single" or "playlist"

    set -l playlist_segment ""
    if test "$video_type" = "playlist"
        set playlist_segment "/$YTDL_PLAYLIST_FMT"
    end

    set -l output_path "$YTDL_OUTPUT_DIR/$download_type$playlist_segment/%(channel)s__\$__%(title)s__#__%(id)s.%(ext)s"

    set -l format_code $YTDL_AUDIO_CODE
    set -l merge_args
    if test "$download_type" = "video"
        set format_code $YTDL_VIDEO_CODE
        set merge_args --merge-output-format mp4
    end

    if _ytdl_run $ytid -o $output_path -f $format_code $merge_args
        # Only convert mp4 to m4a for audio formats, not video
        if test "$download_type" != "video"
            _ytdl_convert_mp4_to_m4a "$YTDL_OUTPUT_DIR/$download_type" $ytid
        end
        return 0
    else
        return 1
    end
end

function _ytdl_download_text
    set -l ytid $argv[1]
    set -l download_type $argv[2] # "text" or "notes"

    set -l out_dir "$YTDL_OUTPUT_DIR/$download_type"
    set -l out_file "$out_dir/%(channel)s__\$__%(title)s__#__%(id)s.%(ext)s"

    # Download audio and transcribe
    _ytdl_run $ytid -o $out_file -f $YTDL_AUDIO_CODE

    # Find the audio file we just downloaded (matches this specific ytid)
    set -l audio_file $out_dir/*__#__$ytid.*
    if test (count $audio_file) -gt 0 -a -f "$audio_file[1]"
        if not string match -qr '\.(txt|srt)$' -- $audio_file[1]
            set -l txt_file (string replace -r '\.[^.]+$' '.txt' -- $audio_file[1])
            echo "[Transcribing] $audio_file[1]"
            transcribe $audio_file[1] | tee $txt_file
        end
    end
end

# ============================================================================
# MAIN
# ============================================================================

set -l ytdl_type ""
set -l input ""

if test (count $argv) -eq 0
    # No args: prompt for type and URL
    set ytdl_type (_ytdl_select_type)
    or exit 1
    read -P "YouTube ID or URL: " input
else if test "$argv[1]" = "clipboard"
    # Clipboard mode: get URL from clipboard, prompt for type
    set input (pbpaste)
    set ytdl_type (_ytdl_select_type)
    or exit 1
else if test (count $argv) -eq 1
    # Single arg: assume it's the type, prompt for URL
    set ytdl_type $argv[1]
    if not _ytdl_validate_type $ytdl_type
        echo "ERROR: Invalid type '$ytdl_type'"
        echo "Valid types: $YTDL_VALID_TYPES"
        exit 1
    end
    read -P "YouTube ID or URL: " input
else
    # Two args: type and URL
    set ytdl_type $argv[1]
    set input $argv[2]
    if not _ytdl_validate_type $ytdl_type
        echo "ERROR: Invalid type '$ytdl_type'"
        echo "Valid types: $YTDL_VALID_TYPES"
        exit 1
    end
end

# Extract video ID from URL
set -l video_id (_ytdl_extract_video_id $input)

# Determine if playlist or single video
set -l video_type "single"
if string match -qr 'list=' -- $input
    if not string match -qr 'v=' -- $input
        set video_type "playlist"
    end
end

echo "=== ytdl ==="
echo "Type: $ytdl_type"
echo "ID: $video_id"
echo "Mode: $video_type"
echo "============"
echo

# Download based on type
switch $ytdl_type
    case music audio video
        _ytdl_download_media $video_id $ytdl_type $video_type
    case text notes
        _ytdl_download_text $video_id $ytdl_type
end
