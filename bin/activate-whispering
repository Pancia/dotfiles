#!/usr/bin/env python3

import subprocess
import time
import sys

LOG_FILE = "/tmp/activate-whispering.log"
HS_BIN = "/Users/anthony/Developer/bin/hs"
PREVIOUS_WINDOW_FILE = "/tmp/whispering-previous-window.txt"


def log(message):
    """Append a log message to the log file."""
    with open(LOG_FILE, "a") as f:
        f.write(f"{message}\n")


def run_hs_command(lua_code):
    """Execute a Hammerspoon Lua command and return the result."""
    try:
        result = subprocess.run(
            [HS_BIN, "-c", lua_code],
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError as e:
        log(f"Hammerspoon command failed: {e.stderr}")
        return None


def send_keystroke(key, modifiers):
    """Send a keystroke using AppleScript System Events."""
    modifier_str = ", ".join(f"{mod} down" for mod in modifiers)
    applescript = f'''
    tell application "System Events"
        keystroke "{key}" using {{{modifier_str}}}
    end tell
    '''
    try:
        subprocess.run(
            ["osascript", "-e", applescript],
            capture_output=True,
            check=True
        )
        return True
    except subprocess.CalledProcessError as e:
        log(f"Keystroke failed: {e.stderr}")
        return False


def is_whispering_frontmost():
    """Check if Whispering app is currently frontmost."""
    lua_code = """
    local app = hs.application.find('Whispering')
    if app and app:isFrontmost() then
        return 'frontmost'
    else
        return 'not_frontmost'
    end
    """
    result = run_hs_command(lua_code)
    log(f"Frontmost check result: {result}")
    return result == "frontmost"


def minimize_whispering():
    """Minimize the Whispering window using Hammerspoon."""
    lua_code = """
    local app = hs.application.find('Whispering')
    if app then
        local wins = app:allWindows()
        if #wins > 0 then
            wins[1]:minimize()
            return 'minimized'
        else
            return 'no windows'
        end
    else
        return 'app not found'
    end
    """
    result = run_hs_command(lua_code)
    log(f"Hammerspoon minimize result: {result}")
    return result


def is_tuple_running():
    """Check if Tuple app is currently running."""
    lua_code = """
    local app = hs.application.find('Tuple')
    if app then
        return 'running'
    else
        return 'not_running'
    end
    """
    result = run_hs_command(lua_code)
    is_running = result == "running"
    log(f"Tuple running check: {is_running}")
    return is_running


def get_focused_window():
    """Get the currently focused app and window ID."""
    lua_code = """
    local win = hs.window.focusedWindow()
    if win then
        local app = win:application()
        if app then
            return app:name() .. '|' .. tostring(win:id())
        end
    end
    return 'none'
    """
    result = run_hs_command(lua_code)
    log(f"Current focused window: {result}")
    return result


def save_focused_window():
    """Save the currently focused window info to a file."""
    window_info = get_focused_window()
    if window_info and window_info != 'none':
        try:
            with open(PREVIOUS_WINDOW_FILE, "w") as f:
                f.write(window_info)
            log(f"Saved previous window: {window_info}")
            return True
        except Exception as e:
            log(f"Failed to save window info: {e}")
            return False
    return False


def focus_whispering():
    """Focus and raise the Whispering window, launching if needed."""
    lua_code = """
    local app = hs.application.find('Whispering')
    if not app then
        hs.printf('[activate-whisper]: App not running, launching...')
        hs.application.open('Whispering')
        hs.timer.usleep(1000000)
        app = hs.application.find('Whispering')
        if not app then return 'failed to launch' end
    end
    local wins = app:allWindows()
    hs.printf('[activate-whisper]: Found %d windows', #wins)
    if #wins > 0 then
        local win = wins[1]
        hs.printf('[activate-whisper]: Focusing window: %s', win:title() or 'nil')
        if win:isMinimized() then win:unminimize() end
        win:focus()
        win:raise()
        return 'focused and raised window'
    else
        return 'no windows found after launch'
    end
    """
    result = run_hs_command(lua_code)
    log(f"Hammerspoon result: {result}")
    return result


def restore_previous_window():
    """Restore focus to the previously saved window."""
    try:
        with open(PREVIOUS_WINDOW_FILE, "r") as f:
            window_info = f.read().strip()

        if not window_info or window_info == 'none':
            log("No previous window to restore")
            return False

        # Parse app_name|window_id
        parts = window_info.split('|')
        if len(parts) != 2:
            log(f"Invalid window info format: {window_info}")
            return False

        app_name, window_id = parts
        log(f"Attempting to restore: {app_name} (window {window_id})")

        lua_code = f"""
        local targetApp = hs.application.find('{app_name}')
        if not targetApp then
            hs.printf('[activate-whisper]: App not found: {app_name}')
            return 'app_not_found'
        end

        local targetWin = hs.window.find({window_id})
        if targetWin then
            hs.printf('[activate-whisper]: Restoring window: %s', targetWin:title() or 'nil')
            if targetWin:isMinimized() then targetWin:unminimize() end
            targetWin:focus()
            targetWin:raise()
            return 'restored_window'
        else
            hs.printf('[activate-whisper]: Window ID not found, focusing app')
            targetApp:activate()
            return 'restored_app'
        end
        """

        result = run_hs_command(lua_code)
        log(f"Restore result: {result}")
        return result in ['restored_window', 'restored_app']
    except FileNotFoundError:
        log("No previous window file found")
        return False
    except Exception as e:
        log(f"Failed to restore window: {e}")
        return False


def main():
    log("=== Starting activation ===")

    log("Checking if Whispering is frontmost...")

    if is_whispering_frontmost():
        log("Whispering is frontmost, stopping recording and restoring previous window...")

        # Stop recording
        send_keystroke("z", ["command", "option", "shift"])
        log("Triggered recording toggle (stop)")

        time.sleep(0.1)

        # Mute mic
        if is_tuple_running():
            send_keystroke("t", ["command", "option", "shift"])
            log("Triggered tuple mic toggle (mute)")
        else:
            log("Tuple not running, skipping mic toggle")

        time.sleep(0.1)

        # Restore previous window
        log("Restoring previous window...")
        restore_previous_window()

    else:
        log("Whispering is not frontmost, activating...")

        # Save current window before switching
        log("Saving current window...")
        save_focused_window()

        time.sleep(0.1)

        # Unmute mic
        if is_tuple_running():
            send_keystroke("t", ["command", "option", "shift"])
            log("Triggered tuple mic toggle (unmute)")
        else:
            log("Tuple not running, skipping mic toggle")

        time.sleep(0.1)

        # Focus window
        log("Calling hammerspoon to focus window...")
        focus_whispering()

        time.sleep(0.2)

        # Start recording
        send_keystroke("z", ["command", "option", "shift"])
        log("Triggered recording toggle (start)")

    log("=== Completed ===")


if __name__ == "__main__":
    main()
